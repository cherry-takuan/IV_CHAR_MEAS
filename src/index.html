<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>keithley 2400 I-V CHAR MEAS</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        #progressBar {
            width: 600px;
            height: 20px;
            border: 1px solid #000;
            background-color: #eee;
            margin: 5px 0;
        }
        #progressFill {
            height: 100%;
            width: 0%;
            background-color: #4caf50;
        }
        table {
            border-collapse: collapse;
            margin-top: 10px;
        }
        table, th, td {
            border: 1px solid black;
            padding: 4px;
        }
    </style>
</head>
<body>
<h1>keithley 2400 I-V CHAR MEAS</h1>
<p>copyright 2025 cherry-tech</p>
<button id="init_btn" onclick="init()">接続</button>
<button id="start_btn" onclick="start()">開始</button>
<button id="stop_btn" onclick="stop()">停止</button>
<button id="clear_btn" onclick="clearData()">クリア</button>
<br>
<label>開始値: <input type="number" id="x_start" value="0"></label>
<label>終了値: <input type="number" id="x_end" value="10"></label>
<button id="set_range" onclick="setRange()">範囲設定</button>
<br>
<label>ステップ:
    <input type="number" id="step" value="0.1" step="0.1">
    <button id="set_step" onclick="setStep()">送信</button>
</label>
<br>
<label>保存モード:
    <select id="saveMode" onchange="setSaveMode()">
        <option value="batch">一括保存</option>
        <option value="realtime">逐次保存</option>
    </select>
</label>
<br>
<!-- ★追加: 2-wire / 4-wire切り替え -->
<label>配線モード:
    <select id="wireMode" onchange="setWireMode()">
        <option value="2wire">2-wire</option>
        <option value="4wire">4-wire</option>
    </select>
</label>

<br>
<label>電圧制限値 [V]:
    <input type="number" id="voltageLimit" step="0.1">
    <button id="voltageLimit_btn" onclick="setVoltageLimit()">送信</button>
</label>
<br>
<label>電流制限値 [A]:
    <input type="number" id="currentLimit" step="0.0001">
    <button id="currentLimit_btn" onclick="setCurrentLimit()">送信</button>
</label>
<br>
<label>平均回数:
    <select id="averageCount" onchange="setAverageCount()">
        <option value="1">1</option>
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
    </select>
</label>

<div id="progressBar"><div id="progressFill"></div></div>
<div id="statusMsg"></div>

<div id="chart" style="width:600px;height:400px;"></div>

<h3>測定条件</h3>
<table id="conditionsTable">
    <tr><th>開始値</th><th>終了値</th><th>ステップ</th><th>保存モード</th><th>配線モード</th></tr>
    <tr><td id="condStart"></td><td id="condEnd"></td><td id="condStep"></td><td id="condSave"></td><td id="condWire"></td></tr>
</table>

<script>
let ws;
let xData = [], yData = [];

function connectWS() {
    ws = new WebSocket("ws://127.0.0.1:8000/ws");
    ws.onopen = () => console.log("WebSocket接続成功");
    ws.onclose = () => {
        console.log("WebSocket切断。再接続します...");
        setTimeout(connectWS, 1000);
    };
    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.status === "standby") {
            if(len(msg.idt) > 0){
                setUILocked_init(false);
            }
            document.getElementById("statusMsg").innerText = msg.idn;
            return;
        }
        if (msg.status === "done") {
            document.getElementById("statusMsg").innerText = "測定終了";
            document.getElementById("progressFill").style.width = "100%";
            setUILocked_run(false);
            return;
        }
        if (msg.status === "running") {
            setUILocked_run(true);
            document.getElementById("statusMsg").innerText = "";
            xData.push(msg.x);
            yData.push(msg.y);

            Plotly.extendTraces('chart', {y: [[msg.y]], x: [[msg.x]]}, [0]);
            document.getElementById("progressFill").style.width = (msg.progress * 100) + "%";

            const cond = msg.conditions;
            document.getElementById("condStart").innerText = cond.x_start;
            document.getElementById("condEnd").innerText = cond.x_end;
            document.getElementById("condStep").innerText = cond.step;
            document.getElementById("condSave").innerText = cond.save_mode;
            document.getElementById("condWire").innerText = cond.wire_mode;
        }
    };
}

function init() {
    fetch("http://127.0.0.1:8000/init", {method: "POST"});
}
function start() {
    Plotly.newPlot('chart', [{x: [], y: [], mode: 'lines'}]);
    xData = []; yData = [];
    document.getElementById("progressFill").style.width = "0%";
    fetch("http://127.0.0.1:8000/start", {method: "POST"});
}

function stop() {
    fetch("http://127.0.0.1:8000/stop", {method: "POST"});
}

function setStep() {
    const val = document.getElementById("step").value;
    fetch(`http://127.0.0.1:8000/set_step/${val}`, {method: "POST"});
}

function setRange() {
    const startVal = document.getElementById("x_start").value;
    const endVal = document.getElementById("x_end").value;
    fetch(`http://127.0.0.1:8000/set_range/${startVal}/${endVal}`, {method: "POST"});
}

function clearData() {
    xData = [];
    yData = [];
    fetch("http://127.0.0.1:8000/clear_data", {method: "POST"});
    Plotly.newPlot('chart', [{x: [], y: [], mode: 'lines'}]);
    document.getElementById("progressFill").style.width = "0%";
    document.getElementById("statusMsg").innerText = "";
}

function setSaveMode() {
    const mode = document.getElementById("saveMode").value;
    fetch(`http://127.0.0.1:8000/set_save_mode/${mode}`, {method: "POST"});
}

// ★追加: 配線モード変更
function setWireMode() {
    const mode = document.getElementById("wireMode").value;
    fetch(`http://127.0.0.1:8000/set_wire_mode/${mode}`, {method: "POST"});
}
function setVoltageLimit() {
    const val = document.getElementById("voltageLimit").value;
    fetch(`http://127.0.0.1:8000/set_voltage_limit/${val}`, {method: "POST"});
}

function setCurrentLimit() {
    const val = document.getElementById("currentLimit").value;
    fetch(`http://127.0.0.1:8000/set_current_limit/${val}`, {method: "POST"});
}

function setAverageCount() {
    const count = document.getElementById("averageCount").value;
    fetch(`http://127.0.0.1:8000/set_average_count/${count}`, {method: "POST"});
}

function setUILocked_run(lock) {
    document.getElementById("init_btn").disabled = lock;
    document.getElementById("start_btn").disabled = lock;
    document.getElementById("stop_btn").disabled  = !lock;
    document.getElementById("clear_btn").disabled = lock;

    document.getElementById("set_range").disabled = lock;
    document.getElementById("set_step").disabled  = lock;

    document.getElementById("wireMode").disabled  = lock;
    document.getElementById("voltageLimit_btn").disabled  = lock;
    document.getElementById("currentLimit_btn").disabled  = lock;
    document.getElementById("averageCount").disabled  = lock;
}

function setUILocked_init(lock) {
    document.getElementById("init_btn").disabled =  !lock;
    document.getElementById("start_btn").disabled = lock;
    document.getElementById("stop_btn").disabled  = lock;
    document.getElementById("clear_btn").disabled = lock;

    document.getElementById("set_range").disabled = lock;
    document.getElementById("set_step").disabled  = lock;

    document.getElementById("wireMode").disabled  = lock;
    document.getElementById("voltageLimit_btn").disabled  = lock;
    document.getElementById("currentLimit_btn").disabled  = lock;
    document.getElementById("averageCount").disabled  = lock;
}
//setUILocked_init(true);
connectWS();
</script>
</body>
</html>
